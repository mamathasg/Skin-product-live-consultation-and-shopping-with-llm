{% extends 'base.html' %}
{% block content %}

<div class="container text-center my-5">
  <h2 class="fw-bold text-success mb-3">Live Dermatologist Consultation</h2>
  <p>
    {% if role == 'derm' %}
      ğŸ‘©â€âš•ï¸ Welcome, <strong>Dr. {{ user_name }}</strong> â€” you are in consultation room <b>{{ room_name }}</b>.
    {% else %}
      ğŸ’†â€â™€ï¸ Welcome, <strong>{{ user_name }}</strong> â€” you are in consultation room <b>{{ room_name }}</b>.
    {% endif %}
  </p>

  <!-- Video Section -->
  <div class="p-4 rounded-4" style="background-color: #e7efe8;">
    <div class="video-wrapper d-flex flex-wrap justify-content-center align-items-start gap-4">

      <!-- Remote (Other Participant) Video -->
      <div class="video-box text-center shadow-sm rounded-3 p-2 bg-white">
        <h5 class="text-muted mb-2">
          {% if role == 'derm' %} Patient {% else %} Dermatologist {% endif %}
        </h5>
        <div id="remoteVideo"
             class="video-frame border border-success border-opacity-50"
             style="background: black; border-radius: 12px; width: 480px; height: 320px; overflow: hidden;">
        </div>
      </div>

      <!-- Local (You) Video -->
      <div class="video-box text-center shadow-sm rounded-3 p-2 bg-white">
        <h5 class="text-muted mb-2">
          {% if role == 'derm' %} You (Dermatologist) {% else %} You {% endif %}
        </h5>
        <div id="localVideo"
             class="video-frame border border-success border-opacity-50"
             style="background: black; border-radius: 12px; width: 480px; height: 320px; overflow: hidden;">
        </div>
      </div>
    </div>
  </div>

  <!-- Controls -->
  <div class="mt-4 d-flex flex-wrap justify-content-center gap-3">
    <button id="toggleMic" class="btn btn-outline-success px-4">ğŸ¤ Mute</button>
    <button id="toggleCamera" class="btn btn-outline-success px-4">ğŸ“· Turn Off Camera</button>
    <button id="leaveBtn" class="btn btn-danger px-4 fw-semibold">âŒ Leave Consultation</button>
  </div>
</div>

<!-- ğŸŒ¿ Custom Leave Confirmation Modal -->
<div id="leaveModal" class="modal-overlay d-none">
  <div class="modal-box">
    <h5 class="fw-bold text-success mb-3">Leave Consultation?</h5>
    <p>Are you sure you want to leave the consultation session?</p>
    <div class="mt-3 d-flex justify-content-center gap-3">
      <button id="confirmLeave" class="btn btn-success px-4">Yes</button>
      <button id="cancelLeave" class="btn btn-outline-secondary px-4">No</button>
    </div>
  </div>
</div>

<!-- Twilio Video SDK -->
<script src="https://sdk.twilio.com/js/video/releases/2.31.0/twilio-video.min.js"></script>
<script>
  const token = "{{ access_token|safe }}";
  const roomName = "{{ room_name }}";
  let activeRoom;
  let micEnabled = true;
  let camEnabled = true;

  async function startVideoChat() {
    try {
      // Create local tracks manually so we can control them
      const localTracks = await Twilio.Video.createLocalTracks({
        audio: true,
        video: { width: 640, height: 480 }
      });

      // Connect with the created tracks
      const room = await Twilio.Video.connect(token, {
        name: roomName,
        tracks: localTracks
      });

      activeRoom = room;
      console.log(`âœ… Connected to Room: ${room.name}`);

      // Display local video
      const localContainer = document.getElementById("localVideo");
      const videoTrack = localTracks.find(t => t.kind === "video");
      localContainer.appendChild(videoTrack.attach());

      // Display remote video
      const remoteContainer = document.getElementById("remoteVideo");
      room.participants.forEach(p => handleParticipant(p, remoteContainer));
      room.on("participantConnected", p => handleParticipant(p, remoteContainer));

      // ----- MIC TOGGLE -----
      const micButton = document.getElementById("toggleMic");
      micButton.onclick = () => {
        const audioTrack = localTracks.find(t => t.kind === "audio");
        micEnabled = !micEnabled;
        if (audioTrack) audioTrack.enable(micEnabled);
        micButton.innerHTML = micEnabled ? "ğŸ¤ Mute" : "ğŸ”‡ Unmute";
        micButton.classList.toggle("btn-outline-danger", !micEnabled);
      };

      // ----- CAMERA TOGGLE -----
      const camButton = document.getElementById("toggleCamera");
      camButton.onclick = () => {
        const videoTrack = localTracks.find(t => t.kind === "video");
        camEnabled = !camEnabled;
        if (videoTrack) videoTrack.enable(camEnabled);
        camButton.innerHTML = camEnabled ? "ğŸ“· Turn Off Camera" : "ğŸ“¸ Turn On Camera";
        camButton.classList.toggle("btn-outline-danger", !camEnabled);
      };

      // ----- LEAVE BUTTON -----
      const modal = document.getElementById("leaveModal");
      const confirmBtn = document.getElementById("confirmLeave");
      const cancelBtn = document.getElementById("cancelLeave");

      document.getElementById("leaveBtn").onclick = () => modal.classList.remove("d-none");

      confirmBtn.onclick = () => {
        if (activeRoom) activeRoom.disconnect();
        window.location.href = "{{ url_for('consultation') }}";
      };
      cancelBtn.onclick = () => modal.classList.add("d-none");

    } catch (error) {
      console.error("âŒ Error connecting:", error);
      alert("Could not start video session. Please check console or your Twilio credentials.");
    }
  }

  function handleParticipant(participant, container) {
    console.log(`ğŸ‘¤ Participant connected: ${participant.identity}`);
    participant.tracks.forEach(pub => {
      if (pub.isSubscribed) container.appendChild(pub.track.attach());
    });
    participant.on("trackSubscribed", track => {
      container.innerHTML = "";
      container.appendChild(track.attach());
    });
  }

  startVideoChat();
</script>


<style>
  /* ğŸŒ¿ Modal Styling */
  .modal-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.45);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
  }

  .modal-box {
    background: #f8f9f5;
    padding: 30px 40px;
    border-radius: 16px;
    text-align: center;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
    max-width: 400px;
    width: 90%;
    border: 2px solid #cde3c2;
    animation: pop 0.2s ease-in-out;
  }

  @keyframes pop {
    from { transform: scale(0.95); opacity: 0.6; }
    to { transform: scale(1); opacity: 1; }
  }

  .d-none { display: none; }

  /* ğŸŒ¿ Responsive Layout */
  @media (max-width: 992px) {
    .video-frame {
      width: 100% !important;
      height: auto !important;
      aspect-ratio: 16 / 9;
    }
  }

  @media (max-width: 576px) {
    .video-wrapper {
      flex-direction: column !important;
      align-items: center;
    }
    .video-box {
      width: 100%;
      max-width: 90%;
    }
  }
</style>

{% endblock %}
